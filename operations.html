<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Operations &mdash; ci-ochopod 1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/flasky.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="ci-ochopod 1.0 documentation" href="index.html" />
    <link rel="prev" title="CD" href="cd.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body>
  
  

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="cd.html" title="CD"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">ci-ochopod 1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="operations">
<h1>Operations<a class="headerlink" href="#operations" title="Permalink to this headline">¶</a></h1>
<div class="section" id="ci-backend-deployment">
<h2>CI Backend Deployment<a class="headerlink" href="#ci-backend-deployment" title="Permalink to this headline">¶</a></h2>
<p>You first need a functional <a class="reference external" href="http://mesos.apache.org/">Mesos</a> cluster equipped with <a class="reference external" href="https://github.com/autodesk-cloud/ochothon">Ochothon</a> (please refer to their respective documentations
for details).</p>
<p>The <em>YAML definition</em> to use for each component can be found in the repository (grep for <em>marathon.yml</em>). Please note
some of them specify settings that are not defaulted (especially for the slaves which require a few credentials and
the <a class="reference external" href="https://slack.com/">Slack</a> relay). You can copy them all in one place and edit them according to your needs.</p>
<p>Go ahead and add all those pods in an arbitrary &#8220;ci&#8221; namespace (for instance). We first need a <a class="reference external" href="http://redis.io/">Redis</a> pod in
that namespace to act as a buffer &amp; queue. We then need at least one <em>hook</em> pod (to receive HTTP POST requests from Git)
and a at least one <em>slave</em> pod. Finally we need to add a top-level <a class="reference external" href="http://www.haproxy.org/">HAProxy</a> to direct traffic to the hooks and a <a class="reference external" href="https://slack.com/">Slack</a>
relay to forward notifications.</p>
<p>Open the CLI and deploy. For instance:</p>
<div class="code bash highlight-python"><div class="highlight"><pre>$ cd images/marathon
$ ocho cli my-cluster
welcome to the ocho CLI ! (CTRL-C or exit to get out)
my-cluster &gt; deploy -n ci hook/marathon.yml
my-cluster &gt; deploy -n ci redis/marathon.yml
my-cluster &gt; deploy -n ci haproxy/marathon.yml
my-cluster &gt; deploy -n ci slack-relay/marathon.yml
my-cluster &gt; deploy -n ci slave/marathon.yml
</pre></div>
</div>
<p>Once this is done you should have 5 pods running on your cluster:</p>
<div class="code bash highlight-python"><div class="highlight"><pre>$ ocho cli my-cluster
welcome to the ocho CLI ! (CTRL-C or exit to get out)
my-cluster &gt; ls
5 pods, 100% replies -&gt;

cluster                     |  ok   |  status
                            |       |
ci.hook                     |  1/1  |
ci.redis                    |  1/1  |
ci.haproxy                  |  1/1  |
ci.slack-relay              |  1/1  |
ci.slave                    |  1/1  |
</pre></div>
</div>
<p>Note the <em>haproxy</em> URL (and make sure it is reachable from your Git deployment). The container will bind to its host&#8217;s
TCP 9000. For instance:</p>
<div class="code bash highlight-python"><div class="highlight"><pre>$ ocho cli my-cluster
welcome to the ocho CLI ! (CTRL-C or exit to get out)
my-cluster &gt; port 9000
1 pods, 100% replies -&gt;

pod                   |  pod IP        |  public IP  |  TCP
                      |                |             |
ci-backend.haproxy #0 |  10.50.85.97   |             |  9000
</pre></div>
</div>
<p>Pay also attention to the <em>hook</em> auto-generated secret token. This random identifier must be used when setting up your
web-hook. For instance:</p>
<div class="code bash highlight-python"><div class="highlight"><pre>$ ocho cli my-cluster
welcome to the ocho CLI ! (CTRL-C or exit to get out)
my-cluster &gt; poll *hook
1 pods, 100% replies -&gt;

pod                  |  metrics
                     |
ci-backend.hook #0   |  {&quot;token&quot;: &quot;2ko9rHdj/JD&quot;, &quot;uptime&quot;: &quot;2.0 hours (pid 9)&quot;}
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You can specify this token in the <em>hook</em> pod configuration if you prefer to stick with a known quantity. Not doing
so will generate a random identifier upon the pod startup.</p>
</div>
</div>
<div class="section" id="scaling-up">
<h2>Scaling up<a class="headerlink" href="#scaling-up" title="Permalink to this headline">¶</a></h2>
<p>You can simply scale your CI backend up by cranking the number of <em>hook</em> or <em>slave</em> up. You can do it either in the
CLI or via the <a class="reference external" href="https://mesosphere.github.io/marathon/">Marathon</a> API.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Changing the number of slave pods will impact the internal hashing performed to assign repositories to specific
slaves. After doing so it is highly probable repositories will have to be cached again on a different machine.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/autodesk-logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Operations</a><ul>
<li><a class="reference internal" href="#ci-backend-deployment">CI Backend Deployment</a></li>
<li><a class="reference internal" href="#scaling-up">Scaling up</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="cd.html" title="previous chapter">CD</a></li>
  </ul></li>
</ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="footer">
    &copy; Copyright 2015, Autodesk.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
  </div>
  
  </body>
</html>